<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
<meta property="og:type" content="website">
<meta property="og:title" content="rain的随笔">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="rain的随笔">
<meta property="og:description" content="记录一些关于数学、计算机的知识，以及一些日常。">
<meta property="og:locale" content="zh">
<meta property="article:author" content="rain">
<meta property="article:tag" content="数学 计算机 御坂美琴">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>rain的随笔</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">rain的随笔</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">A secret base!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">16</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">49</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/11/08/VLAN%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%BD%91%E5%8F%A3%E8%BD%AF%E8%B7%AF%E7%94%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/08/VLAN%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%BD%91%E5%8F%A3%E8%BD%AF%E8%B7%AF%E7%94%B1/" class="post-title-link" itemprop="url">单网口软路由</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-08 00:45:20 / Modified: 14:03:03" itemprop="dateCreated datePublished" datetime="2022-11-08T00:45:20+08:00">2022-11-08</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/11/08/VLAN%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%BD%91%E5%8F%A3%E8%BD%AF%E8%B7%AF%E7%94%B1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/11/08/VLAN%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%BD%91%E5%8F%A3%E8%BD%AF%E8%B7%AF%E7%94%B1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>起因是发现在原本的两个路由器间架设wireguard隧道，其中一个路由器(小米4A千兆版)遇到了CPU瓶颈，导致带宽只能达到100-200左右。后面研究了市面上的各种路由器的CPU型号，包括矿渣路由器。购买了一个100元的可以刷openwrt的竞斗云2.0，带宽可以达到200-300M，但仍远低于理想的千兆。可以说，目前即便是500元以上的高端路由器，其配置仍然只有4核Cortex <a href="mailto:A53@2.0GHz">A53@2.0GHz</a>的水平。</p>
<p>偶然看到用旧笔记本做软路由的视频，遂萌生了折腾软路由的想法。仔细研究其方案后发现为pppoe拨号上网的方式，不适用于dhcp上网的情况。后偶然发现所购买路由器支持vlan功能（其实所有openwrt路由器都支持），于是自己独立构思了后面的架构图。并尝试成功(11/5)，最终在红米AX6S+软路由的情况下，达到了500M的带宽，此时AX6S的双核Cortex <a href="mailto:A53@1.2GHz">A53@1.2GHz</a> CPU占用率也达到了100%。</p>
<p>之后再接再励，将AX6S也配置了vlan，并在旧笔记本实现软路由。最终终于带宽可以达到880Mbps的水平，scp文件能达到98MB/s的速率。并且还配置成功了Guest WIFI，实现了隔离，保证安全。</p>
<p>通过本次项目，学会了：</p>
<ul>
<li>linux下，ip, netplan创建bridge和vlan</li>
<li>lxc的使用</li>
<li>openwrt DSA架构配置vlan</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p>司波图：使用笔记本 + PVE，单网口实现软路由：<a href="https://www.youtube.com/watch?v=eqmOnCHM-kc" target="_blank" rel="noopener">一个网口也能做软路由？闲置电脑再利用！ - YouTube</a></p>
<ul>
<li>不过这里的结构只适用于pppoe上网方式，对于dhcp上网方式则不适用（此结构中只有软路由一个dhcp服务器，不用考虑dhcp冲突。对于dhcp上网方式则需要使用vlan隔离ISP的dhcp和软路由的dhcp服务）</li>
<li>结构：<img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221106141755.png" alt="pppoe单口软路由"></li>
</ul>
</li>
<li><p>利用树莓派 + LXC运行多个服务，并使用Openwrt作为防火墙管理：<a href="http://www.makikiweb.com/Pi/lxc_openwrt.html" target="_blank" rel="noopener">www.makikiweb.com/Pi/lxc_openwrt.html</a></p>
<ul>
<li>新版教程：<a href="http://www.makikiweb.com/Pi/virtual_openwrt_on_lxd.html" target="_blank" rel="noopener">www.makikiweb.com/Pi/virtual_openwrt_on_lxd.html</a></li>
</ul>
</li>
</ul>
<h2 id="单网口实现软路由"><a href="#单网口实现软路由" class="headerlink" title="单网口实现软路由"></a>单网口实现软路由</h2><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p>switch:</p>
<ul>
<li>绿：端口  </li>
<li>橙：设备  </li>
<li>虚线：虚拟设备  </li>
<li>蓝：网桥  </li>
<li>灰：网络接口<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108140021.png" alt="单网口软路由架构图"></li>
</ul>
<p>DSA</p>
<ul>
<li>橙：设备  </li>
<li>虚线：虚拟设备  </li>
<li>蓝：网桥  </li>
<li>绿：网络接口<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108140122.png" alt=""></li>
</ul>
<h3 id="1-设置host"><a href="#1-设置host" class="headerlink" title="1. 设置host"></a>1. 设置host</h3><h4 id="lxc"><a href="#lxc" class="headerlink" title="lxc"></a>lxc</h4><p>安装lxd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install lxd   # 安装lxd</span><br><span class="line">lxd init  # 会设置存储池，网络bridge，全部默认即可</span><br></pre></td></tr></table></figure>

<p>创建一个包含两个网络接口的profile，用于openwrt。（还可以创建一个只包含br1的profile，用于其余lxc容器）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc profile create twointf</span><br><span class="line">lxc profile edit twointf</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">config: &#123;&#125;</span><br><span class="line">description: 2 interfaces</span><br><span class="line">devices:</span><br><span class="line">  eth0:</span><br><span class="line">    name: eth0</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: br1</span><br><span class="line">    type: nic</span><br><span class="line">  eth1:</span><br><span class="line">    name: eth1</span><br><span class="line">    nictype: bridged</span><br><span class="line">    parent: br0</span><br><span class="line">    type: nic</span><br><span class="line">  root:</span><br><span class="line">    path: &#x2F;</span><br><span class="line">    pool: default</span><br><span class="line">    type: disk</span><br><span class="line">name: twointf</span><br></pre></td></tr></table></figure>

<p>拉取openwrt镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc image copy images:openwrt&#x2F;22.03 local: --copy-aliases --auto-update</span><br></pre></td></tr></table></figure>

<h4 id="bridge-vlan"><a href="#bridge-vlan" class="headerlink" title="bridge, vlan"></a>bridge, vlan</h4><p>设置netplan，按照bridge, vlan节，创建两个vlan和br0, br1。</p>
<h3 id="2-路由器vlan设置"><a href="#2-路由器vlan设置" class="headerlink" title="2. 路由器vlan设置"></a>2. 路由器vlan设置</h3><p>见后面DSA设置节</p>
<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><p>从实验室到寝室的wireguard隧道可以达到500Mbs的速率，将两核Cortex <a href="mailto:A53@1.2GHz">A53@1.2GHz</a>几乎跑满。而原本通过路由器(4核MIPS 1004kc@880MHz)则仅能跑到200Mbs。<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221106160620.png" alt=""></p>
<p>两边均使用软路由后达到千兆水平, scp可以达到98MB/s的速率。</p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108003939.png" alt=""></p>
<h2 id="创建bridge-vlan"><a href="#创建bridge-vlan" class="headerlink" title="创建bridge, vlan"></a>创建bridge, vlan</h2><h3 id="iproute2-临时设置"><a href="#iproute2-临时设置" class="headerlink" title="iproute2(临时设置)"></a>iproute2(临时设置)</h3><ul>
<li>bridge：<a href="https://wiki.archlinux.org/title/network_bridge" target="_blank" rel="noopener">Network bridge - ArchWiki (archlinux.org)</a></li>
<li>vlan: <a href="https://wiki.archlinux.org/title/VLAN#Create_the_VLAN_device" target="_blank" rel="noopener">VLAN - ArchWiki (archlinux.org)</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lsmod |grep 802</span><br><span class="line"></span><br><span class="line">#添加vlan和bridge</span><br><span class="line">sudo ip link add link enp7s0 eth0.1 type vlan id 1</span><br><span class="line">sudo ip link add link enp7s0 eth0.2 type vlan id 2</span><br><span class="line">sudo ip link add name br0 type bridge</span><br><span class="line">sudo ip link add name br1 type bridge</span><br><span class="line"></span><br><span class="line">#set up</span><br><span class="line">sudo ip link set dev br0 up</span><br><span class="line">sudo ip link set dev br1 up</span><br><span class="line">sudo ip link set dev eth0.1 up</span><br><span class="line">sudo ip link set dev eth0.2 up</span><br><span class="line"></span><br><span class="line">#设置bridge master</span><br><span class="line">sudo ip link set eth0.2 master br1 </span><br><span class="line">sudo ip link set eth0.1 master br0</span><br></pre></td></tr></table></figure>

<h3 id="netplan-networkmanager"><a href="#netplan-networkmanager" class="headerlink" title="netplan/networkmanager"></a>netplan/networkmanager</h3><p>nmcli命令还行，不过配置复杂网络时还是使用netplan配置文件的方式更加适合</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nmcli con add ifname br0 type bridge con-name br0</span><br><span class="line">nmcli con add type bridge-slave ifname enp7s0 master br0</span><br><span class="line">nmcli con up br0</span><br><span class="line"></span><br><span class="line">nmcli con add type vlan con-name vlan1 dev enp7s0 id 1</span><br></pre></td></tr></table></figure>

<h3 id="netplan-networkd-推荐"><a href="#netplan-networkd-推荐" class="headerlink" title="netplan/networkd(推荐)"></a>netplan/networkd(推荐)</h3><p>ubuntu桌面版，netplan底层使用的默认时NetworkManger。服务器版则是networkd，networkd的配置文件使用起来更简单些。</p>
<p>配置文档：<a href="https://netplan.io/examples#configuring-network-bridges" target="_blank" rel="noopener">Canonical Netplan</a></p>
<p>配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    eth0:</span><br><span class="line">      dhcp4: false</span><br><span class="line">      dhcp6: false</span><br><span class="line">  vlans:</span><br><span class="line">    eth0.1:</span><br><span class="line">      link: eth0</span><br><span class="line">      id: 1</span><br><span class="line">    eth0.2:</span><br><span class="line">      link: eth0</span><br><span class="line">      id: 2</span><br><span class="line">  bridges:</span><br><span class="line">    br0:</span><br><span class="line">      interfaces:</span><br><span class="line">        - eth0.1</span><br><span class="line">    br1:</span><br><span class="line">      dhcp4: true</span><br><span class="line">      interfaces:</span><br><span class="line">        - eth0.2</span><br></pre></td></tr></table></figure>
<p>配置完成后，需要应用修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netplan apply</span><br></pre></td></tr></table></figure>

<h5 id="设置网卡固定名称"><a href="#设置网卡固定名称" class="headerlink" title="设置网卡固定名称"></a>设置网卡固定名称</h5><p>默认情况下，当机器PCIE设备变化时，网络接口名字可能会发生变化（比如拔插显卡）。解决办法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;udev&#x2F;rules.d&#x2F;80-net.rules</span><br><span class="line"></span><br><span class="line"># 80-net.rules</span><br><span class="line">SUBSYSTEM&#x3D;&#x3D;&quot;net&quot;, ACTION&#x3D;&#x3D;&quot;add&quot;, DRIVERS&#x3D;&#x3D;&quot;?*&quot;, ATTR&#123;address&#125;&#x3D;&#x3D;&quot;7c:10:c9:a2:53:d8&quot;, NAME&#x3D;&quot;eth0&quot;</span><br><span class="line">SUBSYSTEM&#x3D;&#x3D;&quot;net&quot;, ACTION&#x3D;&#x3D;&quot;add&quot;, DRIVERS&#x3D;&#x3D;&quot;?*&quot;, ATTR&#123;address&#125;&#x3D;&#x3D;&quot;38:fc:98:8d:f8:7e&quot;, NAME&#x3D;&quot;wlan0&quot;</span><br><span class="line"></span><br><span class="line">update-initramfs -u -k all    # -u (updates initramfs), -k all(specific all kernel version)</span><br></pre></td></tr></table></figure>


<h2 id="Openwrt-VLAN设置"><a href="#Openwrt-VLAN设置" class="headerlink" title="Openwrt VLAN设置"></a>Openwrt VLAN设置</h2><ul>
<li>官方文档：<a href="https://openwrt.org/docs/guide-user/network/vlan/switch_configuration" target="_blank" rel="noopener">[OpenWrt Wiki] VLAN</a></li>
</ul>
<h3 id="vlan-Q-amp-A"><a href="#vlan-Q-amp-A" class="headerlink" title="vlan Q &amp; A"></a>vlan Q &amp; A</h3><ul>
<li>vlan作用是什么？：分离不同设备（位于同一个LAN）。优点：不用设置子网段和路由。</li>
<li>vlan标准：<strong>IEEE 802.1Q</strong>。vlan会在以太网帧中添加4字节，因此通信双方必须要都能识别vlan<ul>
<li><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221106144229.png" alt=""></li>
</ul>
</li>
<li>哪些设备支持vlan？：基本上所有设备都支持vlan（软件的或者硬件交换机）。<ul>
<li>对于有多个端口的嵌入式设备，内部通常会包含一个<strong>VLAN-capable switch</strong>，或者称managed switch。管理交换机和设备内部的一个ethernet接口连接在一起。管理交换机可以为每个端口设置vlan id，并且<strong>可以独立于CPU工作</strong>。</li>
<li>对于PC或则单板计算机，每个端口都有一个独立的以太网控制器(nic)，<strong>vlan通过操作系统驱动实现</strong>。</li>
</ul>
</li>
<li>如何查看自己设备是否有硬件switch？<ul>
<li>通过<code>ls -l /sys/class/net</code>可以查看物理的网络接口</li>
<li>用过的小米路由器均没有专门的switch页面，后面才知道是采用了DSA架构，每个端口都显式为一个设备，如lan1, lan2, wan。实际上均是位于eth0下。</li>
</ul>
</li>
</ul>
<h3 id="硬件switch-vlan"><a href="#硬件switch-vlan" class="headerlink" title="硬件switch vlan"></a>硬件switch vlan</h3><p>下图为一个常见的5端口路由器的vlan设置，该路由器只有一个网络接口(eth0)，包含一个内置的交换机，通过vlan将WAN和LAN隔离。<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221106145016.png" alt=""></p>
<p>对于swtich实现的vlan，openwrt有一个页面用于图形化地设置vlan。（使用DSA架构后就没了，见后DSA节）</p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221106152732.png" alt=""></p>
<ul>
<li>tagged:  The <em>tagged</em> port (<code>t</code> is appended to the port number) is the one that forces usage of VLAN tags, i.e. when the packet is outgoing, the VLAN ID tag with <code>vlan</code> value is added to the packet, and when the packet is incoming, the VLAN ID tag has to be present and match the configured <code>vlan</code> value(s).</li>
<li>untagged:  The <em>untagged</em> port is removing the VLAN ID tag when leaving the port – this is used for communication with ordinary devices that does not have any clue about VLANs. When the untagged packet arrives to the port, the default port VLAN ID (called <code>pvid</code>) is assigned to the packet automatically. The <code>pvid</code> value can be selected by the <code>switch_port</code> section.</li>
</ul>
<h3 id="软件vlan"><a href="#软件vlan" class="headerlink" title="软件vlan"></a>软件vlan</h3><p>每个物理接口(nic)可以通过vlan id虚拟出多个虚拟接口（如eth0.1, eth0.2）。当包路由到对应虚拟接口时，包离开物理接口时会打上对应tag。当物理接口接收到对应tag的包时，则会路由到对应虚拟接口（不存在则会drop）。</p>
<blockquote>
<p>A driver-level VLAN could be created in the <code>interface</code> section by adding a dot (<code>.</code>) and the respective VLAN ID after the interface name (in the <code>ifname</code> option), like <code>eth1.2</code> for VLAN ID 2 on <code>eth1</code>. When any internal software routing decision sends the packet to the software VLAN, it leaves the respective interface (<code>eth1</code> in our example) with the VLAN tag present and VLAN ID set to the number corresponding to the interface name (<code>2</code> in our example on <code>eth1.2</code>).<br>if the incoming packet arrives to the interface with software VLANs (incoming packet to <code>eth1</code>) and has a VLAN ID tag set, it appears on the respective software-VLAN-interface instead (VLAN ID 2 tag arrives on <code>eth1.2</code>) – if it exists in the configuration! Otherwise the packet is dropped. Non-tagged packets are delivered to non-VLAN interface (<code>eth1</code>) as usual.</p>
</blockquote>
<p>当把non-VLAN接口和VLAN接口桥接时，操作系统负责增加和删除tag</p>
<blockquote>
<p>When you bridge non-VLAN and VLAN interfaces together, the system takes care about adding VLAN ID when sending packet from non-VLAN to VLAN interface, and it automatically removes the VLAN ID when sending packet from VLAN interface to non-VLAN one.</p>
</blockquote>
<h3 id="DSA设置"><a href="#DSA设置" class="headerlink" title="DSA设置"></a>DSA设置</h3><p><strong>Distributed Switch Architecture(DSA)</strong> 是linux kernel对网络架构的一个调整，openwrt从21的版本开始使用该架构。<br>参考：</p>
<ul>
<li><strong>推荐仔细观看</strong>：<a href="https://www.youtube.com/watch?v=qeuZqRqH-ug" target="_blank" rel="noopener">VLANs in OpenWrt 21 - YouTube</a></li>
<li>官方wiki：<a href="https://openwrt.org/docs/guide-user/network/dsa/dsa-mini-tutorial" target="_blank" rel="noopener">[OpenWrt Wiki] DSA Mini-Tutorial</a></li>
</ul>
<h4 id="DSA-vs-swconfig"><a href="#DSA-vs-swconfig" class="headerlink" title="DSA vs swconfig"></a>DSA vs swconfig</h4><p>openwrt 19以前版本使用swconfig，从21的版本开始使用DSA。</p>
<p>区别总结：</p>
<ul>
<li>21可以显式定义vlan device（802.1q），19则是在interface通过选择device时手动添加后缀，隐式配置。</li>
<li>指定端口标签方式<ul>
<li>19中，专门的switch页面，指定不同端口如何打标签</li>
<li>21中，每个port变成单独一个device（如lan1, lan2, wan）。可以创建一个bridge添加lan1, lan2, wan，然后通过bridge vlan filtering来指定不同端口的打标签方式。</li>
</ul>
</li>
</ul>
<p>21总结</p>
<ul>
<li>define VLAN on the bridge</li>
<li>tag and untag on the bridge</li>
<li>attach wifi to the interface</li>
</ul>
<h4 id="ingress-vs-egress-tagged-vs-untagged含义"><a href="#ingress-vs-egress-tagged-vs-untagged含义" class="headerlink" title="ingress vs egress, tagged vs untagged含义"></a>ingress vs egress, tagged vs untagged含义</h4><ul>
<li>egress tagged：发往VLAN 100的包，会从指定端口发出，并且在以太网帧中插入tag。适用于对面也是vlan-aware设备</li>
<li>egress untagged: 发往VLAN 100的包，会从指定端口发出，并且在以太网帧中移除tag。适用于连接普通设备，一个端口只能对应一个untagged vlan。</li>
<li>对于入站的情况，如果包有tag，则直接发往对应的vlan。如果是untagged的，则添加PVID，发往对应vlan。</li>
</ul>
<h4 id="swconfig配置实例-p2w"><a href="#swconfig配置实例-p2w" class="headerlink" title="swconfig配置实例(p2w)"></a>swconfig配置实例(p2w)</h4><p>并非21后的版本都使用了DSA，这里p2w使用的op版本为22.03，仍然有switch页面。</p>
<p>设置vlan的过程为</p>
<ul>
<li>在switch中设置端口tagged, untagged，见图1<ul>
<li>图中vlan100的CPU设置了off，这是因为我们不需要处理该部分流量（该部分是学校到软路由虚拟链路）。这样设置<strong>不会</strong>产生eth0.100的设备。</li>
</ul>
</li>
<li>图2为隐式产生的vlan device</li>
<li>添加interface，指定使用的vlan。图3 mgr指定了eth0.99，而lan指定的br-lan连接了eth0.200<br>图1<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107215141.png" alt=""><br>图2<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107215209.png" alt=""><br>图3<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107214659.png" alt=""><br>图4<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107235214.png" alt=""></li>
</ul>
<p>从配置文件来看，通过switch_vlan指定了不同端口如何打上tag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">config switch</span><br><span class="line">        option name &#39;switch0&#39;</span><br><span class="line">        option reset &#39;1&#39;</span><br><span class="line">        option enable_vlan &#39;1&#39;</span><br><span class="line"></span><br><span class="line">config switch_vlan</span><br><span class="line">        option device &#39;switch0&#39;</span><br><span class="line">        option vlan &#39;1&#39;</span><br><span class="line">        option vid &#39;100&#39;</span><br><span class="line">        option ports &#39;4 1t&#39;</span><br><span class="line">        option description &#39;学校到单口软路由&#39;</span><br><span class="line"></span><br><span class="line">config switch_vlan</span><br><span class="line">        option device &#39;switch0&#39;</span><br><span class="line">        option vlan &#39;2&#39;</span><br><span class="line">        option vid &#39;200&#39;</span><br><span class="line">        option ports &#39;0t 3 1t&#39;</span><br><span class="line">        option description &#39;软路由到LAN&#39;</span><br><span class="line"></span><br><span class="line">config switch_vlan</span><br><span class="line">        option device &#39;switch0&#39;</span><br><span class="line">        option vlan &#39;3&#39;</span><br><span class="line">        option vid &#39;99&#39;</span><br><span class="line">        option description &#39;LAN3用于管理&#39;</span><br><span class="line">        option ports &#39;0t 2&#39;</span><br></pre></td></tr></table></figure>

<h4 id="DSA配置实例-ax6s"><a href="#DSA配置实例-ax6s" class="headerlink" title="DSA配置实例(ax6s)"></a>DSA配置实例(ax6s)</h4><p>ax6s有四个端口</p>
<ul>
<li>图1，将所有lan口添加到br-lan（这里其实wan也可以添加进来）</li>
<li>图2，设置端口标签</li>
<li>图3，自动生成了vlan设备，但这次是在br-lan上生成的</li>
<li>图4，创建接口，指定不同vlan设备<ul>
<li>这里wan口专门用于管理<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108000404.png" alt=""></li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108000447.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108000519.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221108000532.png" alt=""></p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="lxc-openwrt-dnsmasq"><a href="#lxc-openwrt-dnsmasq" class="headerlink" title="lxc openwrt dnsmasq"></a>lxc openwrt dnsmasq</h3><ul>
<li>lxc创建openwrt容器，刚开始为手动创建镜像。结果启动容器后发现openwrt内无发上网，进一步发现是dnsmasq没有启动导致域名解析不了。<ul>
<li>按照openwrt论坛中的方法注释掉dnsmasq的启动脚本中的部分行，问题解决。<a href="https://forum.openwrt.org/t/procd-jail-not-work-in-lxc-dnsmasq-fail-to-start/127407/2" target="_blank" rel="noopener">Procd jail not work in lxc, dnsmasq fail to start - For Developers - OpenWrt Forum</a></li>
<li>现在lxc有openwrt官方镜像，没这个问题，但是其lan interface配置用的还是ifname，openwrt luci会提示更新。</li>
</ul>
</li>
</ul>
<h3 id="p2w的wan口坑"><a href="#p2w的wan口坑" class="headerlink" title="p2w的wan口坑"></a>p2w的wan口坑</h3><p>wan口用于管理怎么都不行。一修改swtich菜单，马上失联。使用lan口管理成功</p>
<h3 id="wifi挂载到网桥上才能获得dhcp地址"><a href="#wifi挂载到网桥上才能获得dhcp地址" class="headerlink" title="wifi挂载到网桥上才能获得dhcp地址"></a>wifi挂载到网桥上才能获得dhcp地址</h3><ul>
<li>eth0.200用于lan，lan设置dhcp client，但是p2w获得到了ip，连接wifi的笔记本获得不了。创建一个网桥br-lan，然后添加eth0.200后成功。</li>
</ul>
<h3 id="guest-wifi无法上网"><a href="#guest-wifi无法上网" class="headerlink" title="guest wifi无法上网"></a>guest wifi无法上网</h3><p>在ax6s上创建了一个guest wifi，使用单独的vlan。最终效果如下：</p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107232725.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107232701.png" alt=""></p>
<p>但是创建过程中不知为何guest显式设备不存在，于是手动添加了802.1q设备，vlan id手动指定为201。貌似没有和br-lan中bridge vlan filtering自动创建的802.1q产生冲突。于是设备不存在的问题解决了。</p>
<p>但是guest仍然无法通过dhcp获得ip。tianyi的br-guest也无法获得ip地址（其中215是手动添加的，234是后面成功后自动获得的），tcpdump -i br-guest可以看到有来自ax6s guest接口的dhcp request。</p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107233045.png" alt=""></p>
<p>进入op2，发现也没有生成对应路由，而是全部走192.168.36.1（图中的default和192.168.37.1是后面自动生成的），于是手动添加了一条192.168.37.0/24的规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">default via 192.168.36.1 dev br1 proto dhcp src 192.168.36.215 metric 100</span><br><span class="line">default via 192.168.37.1 dev br-guest proto dhcp src 192.168.37.234 metric 100</span><br><span class="line"></span><br><span class="line">192.168.37.0&#x2F;24 dev br-guest proto kernel scope link src 192.168.37.215</span><br><span class="line">192.168.37.1 dev br-guest proto dhcp scope link src 192.168.37.234 metric 100</span><br></pre></td></tr></table></figure>

<p>但是此时ax6s还是无法dhcp获得ip，于是手动添加了一个37.180的地址，发现仍然ping不通37.1<br>检查op2，发现guest无法访问路由器自身因此无法ping。于是开启了input（之后又关闭了，没问题）<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20221107233655.png" alt=""></p>
<p>此时发现guest已经可以上网了。不知道上面步骤中哪一步导致的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/31/Wireguard%E7%BB%84%E7%BD%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/31/Wireguard%E7%BB%84%E7%BD%91/" class="post-title-link" itemprop="url">Wireguard组网</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-31 22:17:42" itemprop="dateCreated datePublished" datetime="2022-10-31T22:17:42+08:00">2022-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-08 00:49:52" itemprop="dateModified" datetime="2022-11-08T00:49:52+08:00">2022-11-08</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/10/31/Wireguard%E7%BB%84%E7%BD%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/10/31/Wireguard%E7%BB%84%E7%BD%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>wireguard是一种基于UDP的隧道协议，可以在不同设备间建立虚拟隧道，从而连接不同子网。本文总结了不同使用场景</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/10/31/Wireguard%E7%BB%84%E7%BD%91/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/25/Openwrt-Mesh%E5%92%8C%E5%BF%AB%E9%80%9F%E6%BC%AB%E6%B8%B8%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/25/Openwrt-Mesh%E5%92%8C%E5%BF%AB%E9%80%9F%E6%BC%AB%E6%B8%B8%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Openwrt Mesh和快速漫游配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-25 22:17:13" itemprop="dateCreated datePublished" datetime="2022-08-25T22:17:13+08:00">2022-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-31 16:23:49" itemprop="dateModified" datetime="2022-10-31T16:23:49+08:00">2022-10-31</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/08/25/Openwrt-Mesh%E5%92%8C%E5%BF%AB%E9%80%9F%E6%BC%AB%E6%B8%B8%E9%85%8D%E7%BD%AE/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/08/25/Openwrt-Mesh%E5%92%8C%E5%BF%AB%E9%80%9F%E6%BC%AB%E6%B8%B8%E9%85%8D%E7%BD%AE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>家里原本有两个路由器，一个负责楼上，一个负责楼下。但是仍然有许多覆盖不到的地方，比如厨房。并且更影响体验的是楼上楼下的WIFI使用不同的SSID，手机无法很好地自动切换。经常是楼上连接到楼下的网络导致信号很差。因此决定对家里的网络改造一番。</p>
<p>以前听过mesh这个技术，可以将很多台路由器通过无线连接起来，共同提供一个网络。于是去搜索了openwrt是否支持mesh，发现是可以的。并且经过进一步的了解，纠正了自己之前对无线网络的一些错误认知。</p>
<ul>
<li>首先，mesh解决的并不是如何让设备自动切换网络，而是如何进行<strong>无线组网</strong>，可以避免布线的困难。mesh节点通过同一个信道的的无线相互连接，而通过另一个无线提供WIFI。</li>
<li><strong>快速漫游</strong>(fast roaming)协议，精确来说叫做802.11r协议，可以减少设备切换无线网络的耗时。</li>
</ul>
<p>硬件设备上，我选择使用小米路由3G来搭建，主要是因为硬件配置上在wifi5的路由器中算是很不错的了，且某鱼上一个只需要50元。于是又买了两个，加上原本的，现在有4台openwrt路由器，一个红米AC2100作为主路由，3个R3G作为AP节点。</p>
<p>为了方便配置还实现了一个自动配置脚本放在github：<a href="https://github.com/TheRainstorm/my-openwrt-config" target="_blank" rel="noopener">TheRainstorm/my-openwrt-config (github.com)</a></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/08/25/Openwrt-Mesh%E5%92%8C%E5%BF%AB%E9%80%9F%E6%BC%AB%E6%B8%B8%E9%85%8D%E7%BD%AE/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/04/gcc-mpi%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/04/gcc-mpi%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">gcc mpi源码编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-04 16:28:41" itemprop="dateCreated datePublished" datetime="2022-08-04T16:28:41+08:00">2022-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-31 16:24:44" itemprop="dateModified" datetime="2022-10-31T16:24:44+08:00">2022-10-31</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/08/04/gcc-mpi%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/08/04/gcc-mpi%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="GCC"><a href="#GCC" class="headerlink" title="GCC"></a>GCC</h3><h4 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h4><ul>
<li><p>官方<a href="https://www.gnu.org/prep/ftp.html" target="_blank" rel="noopener">GNU Mirror List - GNU Project - Free Software Foundation</a></p>
<ul>
<li><a href="https://ftp.gnu.org/gnu/" target="_blank" rel="noopener">https://ftp.gnu.org/gnu/</a></li>
<li><a href="http://ftp.gnu.org/gnu/" target="_blank" rel="noopener">http://ftp.gnu.org/gnu/</a></li>
</ul>
</li>
<li><p>国内镜像</p>
<ul>
<li><a href="https://mirrors.aliyun.com/gnu/" target="_blank" rel="noopener">https://mirrors.aliyun.com/gnu/</a></li>
<li><a href="https://mirrors.ustc.edu.cn/gnu/" target="_blank" rel="noopener">https://mirrors.ustc.edu.cn/gnu/</a></li>
<li><a href="https://mirrors.tuna.tsinghua.edu.cn/gnu/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/gnu/</a></li>
</ul>
</li>
</ul>
<h4 id="Configure"><a href="#Configure" class="headerlink" title="Configure"></a>Configure</h4><p>注意：</p>
<ul>
<li>不能在src目录configure，而是应该另外创建一个build目录</li>
<li>gcc提供了依赖安装脚本，不用手动去下载</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/dir</span><br><span class="line">wget https://mirrors.ustc.edu.cn/gnu/gcc/gcc-8.5.0/gcc-8.5.0.tar.xz</span><br><span class="line">tar xf gcc-8.5.0.tar.xz</span><br><span class="line"><span class="built_in">cd</span> gcc-8.5.0</span><br><span class="line"><span class="comment">#安装依赖</span></span><br><span class="line">./contrib/download_prerequisites</span><br><span class="line"></span><br><span class="line"><span class="comment">#在build目录下configure</span></span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">mkdir build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line">../gcc-8.5.0/configure --<span class="built_in">disable</span>-multilib --prefix=<span class="variable">$HOME</span>/ENV/gcc-8.5.0 --<span class="built_in">enable</span>-languages=c,c++</span><br><span class="line"></span><br><span class="line">make -j 2&gt;&amp;1 |tee make.log	<span class="comment">#32线程编译大概40分钟左右</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<ul>
<li>–disable-multilib：gcc默认支持编译32位程序(-m32)，关闭此功能</li>
</ul>
<h4 id="解决链接库错误"><a href="#解决链接库错误" class="headerlink" title="解决链接库错误"></a>解决链接库错误</h4><p>原因，程序是动态链接的。运行时使用的是系统的库。而系统的库和编译时使用的库不兼容。</p>
<ul>
<li><p>方法一：修改<code>LD_LIBRARY_PATH</code>环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LD_LIBRARY_PATH&#x3D;$HOME&#x2F;opt&#x2F;gcc-9.1.0&#x2F;lib64</span><br></pre></td></tr></table></figure>
</li>
<li><p>方法二：编译时将库搜索路径存在二进制文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;opt&#x2F;gcc-9.1.0&#x2F;bin&#x2F;g++ -Wl,-rpath&#x3D;$HOME&#x2F;opt&#x2F;gcc-9.1.0&#x2F;lib64 --std&#x3D;c++17 demo.cc -o demo</span><br></pre></td></tr></table></figure>
</li>
<li><p>方法三：静态链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;opt&#x2F;gcc-9.1.0&#x2F;bin&#x2F;g++ --std&#x3D;c++17 demo.cc -o demo -static-libstdc++ -static-libgcc</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><h5 id="解压源码很慢"><a href="#解压源码很慢" class="headerlink" title="解压源码很慢"></a>解压源码很慢</h5><p>服务器上解压60M的源码非常慢，解压了10-20分钟。不只是解压，cp, rm源码目录都非常的慢。推测是NFS的原因。</p>
<p>解决方法为使用本地目录，如/tmp</p>
<h5 id="gcc8-3-0-make失败"><a href="#gcc8-3-0-make失败" class="headerlink" title="gcc8.3.0 make失败"></a>gcc8.3.0 make失败</h5><p><a href="https://stackoverflow.com/questions/62435946/building-gcc-8-3-makefile955-all-error-2" target="_blank" rel="noopener">Building gcc 8.3 [Makefile:955: all] Error 2 - Stack Overflow</a></p>
<p>好像是8.3.0自身的问题，换用8.5.0编译成功</p>
<h3 id="MPI"><a href="#MPI" class="headerlink" title="MPI"></a>MPI</h3><p>MPI编译较快，可以编译很多版本使用</p>
<h4 id="mpich和openmpi对比"><a href="#mpich和openmpi对比" class="headerlink" title="mpich和openmpi对比"></a>mpich和openmpi对比</h4><p>MPICH：<a href="https://www.mpich.org/documentation/guides/" target="_blank" rel="noopener">Guides | MPICH</a></p>
<ul>
<li>支持mpi2.0，功能强大，效率高</li>
<li>缺点是仅支持以太网</li>
</ul>
<p>OpenMPI：</p>
<ul>
<li><p>支持mpi2.0</p>
</li>
<li><p>对于CPU核心较多的节点，推荐使用 openmpi</p>
</li>
<li><p>支持各种网络，包括以太网和infiniband</p>
</li>
</ul>
<h4 id="mpich"><a href="#mpich" class="headerlink" title="mpich"></a>mpich</h4><ul>
<li>参考官方文档：<a href="https://www.mpich.org/static/downloads/4.0.2/mpich-4.0.2-installguide.pdf" target="_blank" rel="noopener">mpich-4.0.2-installguide.pdf</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..&#x2F;configure -prefix&#x3D;$HOME&#x2F;ENV&#x2F;mpich-4.0.2-static CC&#x3D;gcc CXX&#x3D;g++ --disable-fortran --enable-fast&#x3D;all,O3 --with-ucx&#x3D;embedded --disable-shared --enable-static</span><br></pre></td></tr></table></figure>

<ul>
<li><p>–disable-fortran</p>
<ul>
<li>文档里写的是–disable-f77：禁用fortran 77，–disable-fc：禁用Fortran 90（及之后95, 2003, 2008版本）但是尝试后无效，仍然会要求你有fortran编译器。</li>
</ul>
</li>
<li><p>–enable-fast</p>
<p>MPICH libraries are built with default compiler optimization, -O2, which can be modified by –enable-fast configure option. For instance, –disable-fast disables the default optimization option. –enable-fast=O sets default compiler optimization as -O<n></p>
</li>
<li><p>–enable-shared</p>
<ul>
<li>mpicc编译出来的程序使用动态链接，运行时需要设置<code>LD_LIBRARY_PATH</code>。</li>
<li>–disable-shared –enable-static则不用设置<code>LD_LIBRARY_PATH</code></li>
</ul>
</li>
</ul>
<h5 id="Process-Manger"><a href="#Process-Manger" class="headerlink" title="Process Manger"></a>Process Manger</h5><ul>
<li>–with-pm=hydra</li>
</ul>
<p>MPICH has been designed to work with multiple process managers; that is, although you can start MPICH jobs with mpiexec, there are different mechanisms by which your processes are started. An interface (called PMI) isolates the MPICH library code from the process manager. Currently three process managers are distributed with MPICH</p>
<ul>
<li>hydra This is the default process manager that natively uses the existing daemons on the system such as ssh, slurm, pbs.</li>
<li>gforker This is a simple process manager that creates all processes on a single machine. It is useful both for debugging and for running on shared memory multiprocessors.</li>
</ul>
<h5 id="遇到的问题-1"><a href="#遇到的问题-1" class="headerlink" title="遇到的问题"></a>遇到的问题</h5><h6 id="UCX-version"><a href="#UCX-version" class="headerlink" title="UCX version"></a>UCX version</h6><p>configure: error: UCX installation does not meet minimum version requirement (v1.9.0). Please upgrade your installation, or use –with-ucx=embedded</p>
<h6 id="mpirun多节点卡住"><a href="#mpirun多节点卡住" class="headerlink" title="mpirun多节点卡住"></a>mpirun多节点卡住</h6><p>换用–disable-shared –enable-static编译，结果编译错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;ld: &#x2F;tmp&#x2F;yfy&#x2F;build-mpi&#x2F;modules&#x2F;ucx&#x2F;src&#x2F;ucm&#x2F;.libs&#x2F;libucm.a(libucm_la-event.o): in function &#96;ucm_event_install&#39;:</span><br><span class="line">&#x2F;tmp&#x2F;yfy&#x2F;build-mpi&#x2F;modules&#x2F;ucx&#x2F;src&#x2F;ucm&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;mpich-4.0.2&#x2F;modules&#x2F;ucx&#x2F;src&#x2F;ucm&#x2F;event&#x2F;event.c:536: undefined reference to &#96;ucs_load_modules&#39;</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br></pre></td></tr></table></figure>

<h4 id="openmpi"><a href="#openmpi" class="headerlink" title="openmpi"></a>openmpi</h4><ul>
<li><a href="https://docs.open-mpi.org/en/v5.0.x/installing-open-mpi/configure-cli-options/index.html" target="_blank" rel="noopener">4.7. configure command line options — Open MPI 5.0.x documentation (open-mpi.org)</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">..&#x2F;openmpi-4.1.4&#x2F;configure --prefix&#x3D;$HOME&#x2F;ENV&#x2F;openmpi-4.1.4 --disable-mpi-fortran CC&#x3D;gcc CXX&#x3D;g++</span><br></pre></td></tr></table></figure>

<h5 id="运行选项"><a href="#运行选项" class="headerlink" title="运行选项"></a>运行选项</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-v	verbose</span><br><span class="line">-q	quiet</span><br><span class="line">--use-hwthread-cpus		#使用物理核作为slot数目</span><br><span class="line"></span><br><span class="line">-H, -host, --host &lt;host1,host2,...,hostN&gt;</span><br><span class="line">-hostfile, --hostfile &lt;hostfile&gt;</span><br><span class="line">    % cat myhostfile</span><br><span class="line">    aa slots&#x3D;2</span><br><span class="line">    bb slots&#x3D;2</span><br><span class="line">    cc slots&#x3D;2</span><br><span class="line"></span><br><span class="line">-c, -n, --n, -np &lt;#&gt;</span><br><span class="line">-cpus-per-proc, --cpus-per-proc &lt;#perproc&gt;</span><br><span class="line">-bind-to-core, --bind-to-core</span><br><span class="line">-bind-to-socket, --bind-to-socket</span><br></pre></td></tr></table></figure>

<h5 id="遇到的问题-2"><a href="#遇到的问题-2" class="headerlink" title="遇到的问题"></a>遇到的问题</h5><h6 id="run"><a href="#run" class="headerlink" title="run"></a>run</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  workspace mpirun -n 4 .&#x2F;mpi_hello</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">By default, for Open MPI 4.0 and later, infiniband ports on a device</span><br><span class="line">are not used by default.  The intent is to use UCX for these devices.</span><br><span class="line">You can override this policy by setting the btl_openib_allow_ib MCA parameter</span><br><span class="line">to true.</span><br><span class="line"></span><br><span class="line">  Local host:              snode0</span><br><span class="line">  Local adapter:           mlx5_0</span><br><span class="line">  Local port:              1</span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">WARNING: There was an error initializing an OpenFabrics device.</span><br><span class="line"></span><br><span class="line">  Local host:   snode0</span><br><span class="line">  Local device: mlx5_0</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">Hello world from processor snode0, rank 3 out of 4 processors</span><br><span class="line">Hello world from processor snode0, rank 0 out of 4 processors</span><br><span class="line">Hello world from processor snode0, rank 1 out of 4 processors</span><br><span class="line">Hello world from processor snode0, rank 2 out of 4 processors</span><br><span class="line">[snode0:2773927] 3 more processes have sent help message help-mpi-btl-openib.txt &#x2F; ib port not selected</span><br><span class="line">[snode0:2773927] Set MCA parameter &quot;orte_base_help_aggregate&quot; to 0 to see all help &#x2F; error messages</span><br><span class="line">[snode0:2773927] 3 more processes have sent help message help-mpi-btl-openib.txt &#x2F; error in device init</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/07/16/Linux%E5%AE%89%E8%A3%85windows%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/16/Linux%E5%AE%89%E8%A3%85windows%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A/" class="post-title-link" itemprop="url">Linux安装windows虚拟机并显卡直通</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-16 00:42:11" itemprop="dateCreated datePublished" datetime="2022-07-16T00:42:11+08:00">2022-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-03 19:13:07" itemprop="dateModified" datetime="2022-11-03T19:13:07+08:00">2022-11-03</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/07/16/Linux%E5%AE%89%E8%A3%85windows%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/07/16/Linux%E5%AE%89%E8%A3%85windows%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>在linux上使用KVM安装windows虚拟机。然后将显卡直通(pci passthrough)进虚拟机，从而可以在Windows虚拟机上打游戏。</p>
<p>达到一台机器同时运行两个系统，充分利用硬件。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/16/Linux%E5%AE%89%E8%A3%85windows%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/07/01/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E9%A3%8E%E6%B3%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/01/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E9%A3%8E%E6%B3%A2/" class="post-title-link" itemprop="url">实验室网络风波</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-01 14:54:52" itemprop="dateCreated datePublished" datetime="2022-07-01T14:54:52+08:00">2022-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-03 12:02:28" itemprop="dateModified" datetime="2022-07-03T12:02:28+08:00">2022-07-03</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/07/01/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E9%A3%8E%E6%B3%A2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/07/01/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E9%A3%8E%E6%B3%A2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="实验室网络风波"><a href="#实验室网络风波" class="headerlink" title="实验室网络风波"></a>实验室网络风波</h3><p>6月21号下午5点左右实验室断网了(现象是ping百度延迟5,6秒），然后来的维修人员说网口上不允许插路由器。然后我便把路由器断了。经过一两小时后网络才恢复。我期间问了fjw，觉得没有不让用路由器这个说法。晚上便将路由器插回去了，网络没出啥问题。<br>6月23号上午11点，实验室又断网了。czw把我路由器拔了。我觉得如果拔掉期间网络还出问题，也能说明不是路由器的原因。但是到6月30号网络还没有出问题（期间我在补课程综述，完全没访问台式机，所以无感）。所以验证计划失败。不过整个过程中，小黄的路由器是一直插在网口上面的，但是好像没有登录校园网账号，所以也不能说明问题。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/07/01/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E9%A3%8E%E6%B3%A2/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/24/%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">使用docker配置hexo博客环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-24 22:19:21 / Modified: 22:34:05" itemprop="dateCreated datePublished" datetime="2022-05-24T22:19:21+08:00">2022-05-24</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/05/24/%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/05/24/%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>由于nodejs版本较多，直接在宿主机上安装nodejs环境不容易管理。因此可以使用docker维护一个专门用于hexo的环境。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/05/24/%E4%BD%BF%E7%94%A8docker%E9%85%8D%E7%BD%AEhexo%E5%8D%9A%E5%AE%A2%E7%8E%AF%E5%A2%83/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/14/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/14/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/" class="post-title-link" itemprop="url">如何实现网络自由</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-14 01:18:16" itemprop="dateCreated datePublished" datetime="2022-02-14T01:18:16+08:00">2022-02-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-24 16:48:12" itemprop="dateModified" datetime="2022-05-24T16:48:12+08:00">2022-05-24</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/02/14/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/02/14/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="如何实现网络自由"><a href="#如何实现网络自由" class="headerlink" title="如何实现网络自由:-)"></a>如何实现网络自由:-)</h2><p>这里说的网络自由，是指通过网络工具极大地便利生活的某些方面。这篇文章是我自己对折腾路由器刷机、openwrt、ipv6的总结，并尽量说明了各种玩法的实际用途。其中有些操作确实给我带来了极大便利，比如其中使用iSCSI通过网络挂载其它设备的硬盘，这充分解放了我只有500GB的轻薄本。在上面安装游戏后，又可以实现在不同设备上无缝玩同一个游戏的体验。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/02/14/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/13/openwrt%E5%88%B7%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/13/openwrt%E5%88%B7%E6%9C%BA/" class="post-title-link" itemprop="url">openwrt刷机</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-13 01:18:16" itemprop="dateCreated datePublished" datetime="2022-02-13T01:18:16+08:00">2022-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-06 23:09:19" itemprop="dateModified" datetime="2022-11-06T23:09:19+08:00">2022-11-06</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/02/13/openwrt%E5%88%B7%E6%9C%BA/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/02/13/openwrt%E5%88%B7%E6%9C%BA/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Openwrt硬件选择"><a href="#Openwrt硬件选择" class="headerlink" title="Openwrt硬件选择"></a>Openwrt硬件选择</h2><p>如何选择一个可以刷openwrt的路由器？</p>
<ul>
<li><a href="https://post.smzdm.com/p/awznd6qg/" target="_blank" rel="noopener">老房子WiFi布网攻略 篇三十八：WiFi 6 梅林或openwrt固件路由器入手指南_路由器_什么值得买 (smzdm.com)</a></li>
<li><a href="https://post.smzdm.com/p/apzkqlrx/" target="_blank" rel="noopener">老房子WiFi布网攻略 篇二十四：不漏油的路由器不是好矿机，矿渣路由器盘点_路由器_什么值得买 (smzdm.com)</a></li>
<li>极路由、新路由：<a href="https://www.right.com.cn/forum/thread-8097191-1-1.html" target="_blank" rel="noopener">机皇！几种高性价比矿渣路由器比较-新手入门及其它(硬件)-恩山无线论坛 (right.com.cn)</a><h3 id="小米路由器型号总结"><a href="#小米路由器型号总结" class="headerlink" title="小米路由器型号总结"></a>小米路由器型号总结</h3></li>
</ul>
<h4 id="CPU分类"><a href="#CPU分类" class="headerlink" title="CPU分类"></a>CPU分类</h4><ul>
<li>mt7621型号<ul>
<li>R3G：咸鱼50元左右，有USB3.0接口，128MB的flash。</li>
<li>4A千兆版：咸鱼70元左右，外观简约漂亮，16MB NOR flash有点小。</li>
<li>C660x：咸鱼100多，支持wifi6</li>
</ul>
</li>
<li>高通型号<ul>
<li><strong>目前(22.03)只有AX6S是受openwrt官方支持的</strong>，AX6, AX3600有第三方支持。AX5等其余未支持<ul>
<li>不能刷好像是linux kernel还不支持高通的IPQ SoC。</li>
<li>B站看到说AX5刷openwrt需要硬改内存为1G，好像说高通的wifi驱动非常耗内存</li>
</ul>
</li>
<li>AX6S：220左右</li>
<li>AX6：250-300左右</li>
</ul>
</li>
</ul>
<h4 id="小米系列产品"><a href="#小米系列产品" class="headerlink" title="小米系列产品"></a>小米系列产品</h4><ul>
<li><p>红米AX5，小米AX1800换皮</p>
<ul>
<li>IPQ6000, 4核<a href="mailto:A53@1.2Ghz">A53@1.2Ghz</a>：<a href="https://openwrt.org/inbox/toh/xiaomi/xiaomi_ax1800" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi AX1800 (AX5/RA67)</a></li>
</ul>
</li>
<li><p><strong>红米AX6</strong>，小米AX3600换皮</p>
<ul>
<li>AX6, <strong>IPQ8071A</strong>@1.4GHz, 512(ram) + 128：<a href="https://openwrt.org/inbox/toh/xiaomi/xiaomi_redmi_ax6_ax3000" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi Redmi AX6 Wi-Fi 6 Mesh Router</a></li>
<li>AX3600, IPQ8071A, 512 + 256：<a href="https://openwrt.org/inbox/toh/xiaomi/xiaomi_ax3600" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi AX3600</a></li>
<li>对比：<a href="https://www.acwifi.net/11176.html" target="_blank" rel="noopener">红米AX6拆机，旧款WIFI6无线路由器-路由器交流 (acwifi.net)</a></li>
</ul>
</li>
<li><p>AX3000</p>
<ul>
<li><strong>红米AX3000（比较常见）</strong>，IPQ5000：双核<a href="mailto:A53@1.0GHz">A53@1.0GHz</a>, 256(ram) + 128：<a href="https://www.mi.com/shop/buy/detail?product_id=14538" target="_blank" rel="noopener">Redmi路由器AX3000立即购买-小米商城</a></li>
<li>小米AX3000：IPQ5000：双核<a href="mailto:A53@1.0GHz">A53@1.0GHz</a>, 256(ram) + 128：<a href="https://www.mi.com/shop/buy/detail?product_id=14790" target="_blank" rel="noopener">小米路由器AX3000立即购买-小米商城 (mi.com)</a></li>
<li>红米AX3000模具和AX6S一样，为白色。小米AX3000为黑色四棱柱。</li>
</ul>
</li>
<li><p>AX5400</p>
<ul>
<li>红米AX5400，IPQ5018：双核<a href="mailto:A53@1.0GHz">A53@1.0GHz</a>，512(ram) + 128：<a href="https://www.acwifi.net/19451.html" target="_blank" rel="noopener">红米AX5400千兆版拆机，看看与电竞版有什么差别-路由器交流 (acwifi.net)</a></li>
</ul>
</li>
<li><p>AX6000</p>
<ul>
<li>小米AX6000<ul>
<li>IPQ5018, 2核<a href="mailto:A53@1.0Ghz">A53@1.0Ghz</a>, 512(ram) + 128</li>
<li>使用的SoC IPQ5018为高通沉浸式家庭联网平台，不如高通专业联网平台的IPQ8071A（AX3600上的）</li>
</ul>
</li>
<li><strong>红米AX6000（很强）</strong><ul>
<li><strong>MT7986A</strong>, 4核<a href="mailto:A53@2.0Ghz">A53@2.0Ghz</a>, 512(ram) + 128：<a href="https://openwrt.org/toh/xiaomi/redmi_ax6000" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi Redmi AX6000</a></li>
<li><a href="https://www.acwifi.net/19676.html" target="_blank" rel="noopener">红米AX6000拆机，最便宜的四核2.0GHz-路由器交流 (acwifi.net)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20221029213022447.png" alt="image-20221029213022447"></p>
<p>参考</p>
<ul>
<li><p><a href="https://www.zhihu.com/question/474579126" target="_blank" rel="noopener">(33 封私信 / 71 条消息) 路由器红米ax3000和红米ax6选择哪个? - 知乎 (zhihu.com)</a></p>
</li>
<li><p>小米openwrt页面：<a href="https://openwrt.org/toh/hwdata/xiaomi/start" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi</a></p>
</li>
<li><p>常见MediaTek SoC：<a href="https://wikidevi.wi-cat.ru/MediaTek" target="_blank" rel="noopener">MediaTek - WikiDevi.Wi-Cat.RU</a></p>
</li>
</ul>
<h3 id="CPU对比"><a href="#CPU对比" class="headerlink" title="CPU对比"></a>CPU对比</h3><p>参考：</p>
<ul>
<li><p><a href="https://www.right.com.cn/forum/thread-216888-1-1.html" target="_blank" rel="noopener">[转贴] 无线路由器CPU浅析 MT7621A、 BCM47189 到底谁强？-新手入门及其它(硬件)-恩山无线论坛 (right.com.cn)</a></p>
</li>
<li><p>树莓派系列处理器：<a href="https://www.raspberrypi.com/documentation/computers/processors.html" target="_blank" rel="noopener">Raspberry Pi Documentation - Processors</a></p>
<ul>
<li>Raspberry Pi 2 Model B： BCM2836(quad-core Cortex-A7 )</li>
<li>Raspberry Pi 3 Model B：BCM2837( quad-core <a href="mailto:Cortex-A53@1.2">Cortex-A53@1.2</a>)<ul>
<li>50% faster than the Raspberry Pi 2.</li>
</ul>
</li>
<li>Raspberry Pi 3 Models A+, B+: BCM2837B0(quad-core <a href="mailto:Cortex-A53@1.4">Cortex-A53@1.4</a>)<ul>
<li>17% faster than the original Raspberry Pi 3</li>
</ul>
</li>
<li>Raspberry Pi 4 Model B: BCM2837(quad-core <a href="mailto:Cortex-A72@1.5">Cortex-A72@1.5</a> GHz)<ul>
<li>50% faster than the Raspberry Pi 3B+</li>
</ul>
</li>
</ul>
</li>
<li><p>ARM核对比：<a href="https://en.wikipedia.org/wiki/List_of_ARM_processors" target="_blank" rel="noopener">List of ARM processors - Wikipedia</a></p>
<ul>
<li>Cortex-A7: 1.9 DMIPS/MHz per core</li>
<li>A53: 2.3 DMIPS/MHz</li>
<li>A72: 6.3-7.3 DMIPS/MHz</li>
</ul>
</li>
<li><p>MIPS核：<a href="https://www.mips.com/products/classic/" target="_blank" rel="noopener">MIPS Classic Processor Cores - Imagination Technologies</a></p>
<ul>
<li>1004K: 1.6 DMIPS/MHz</li>
</ul>
</li>
<li><p>74k: 1.93 DMIPS/MHz：CSAC路由器：71</p>
</li>
<li><p><a href="https://github.com/sawaYch/newifi3-d2-firmware/blob/master/README.md" target="_blank" rel="noopener">newifi3-d2-firmware/README.md at master · sawaYch/newifi3-d2-firmware (github.com)</a></p>
</li>
</ul>
<h2 id="刷机过程总结"><a href="#刷机过程总结" class="headerlink" title="刷机过程总结"></a>刷机过程总结</h2><p>以红米AC2100可能的刷机为例，涵盖了openwrt的各种情况：刷breed，恢复，临时镜像</p>
<ul>
<li><p><strong>建议直接使用官方openwrt镜像 + 官方安装方式。几次使用breed都遇到了问题，而小米官方恢复工具也挺好用的。</strong></p>
</li>
<li><p>第一次自己刷机红米AC2100[[记录红米AC2100折腾]]，一张精华图</p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20210622145337241.png" alt="image-20210622145337241"></p>
</li>
<li><p>路由器刷出问题，修复经验。知道了备份的重要性[[记录记一次路由器刷出问题修复过程]]</p>
</li>
</ul>
<h2 id="小米路由器救砖"><a href="#小米路由器救砖" class="headerlink" title="小米路由器救砖"></a>小米路由器救砖</h2><h3 id="有官方bootloader的情况"><a href="#有官方bootloader的情况" class="headerlink" title="有官方bootloader的情况"></a>有官方bootloader的情况</h3><p><strong>说明：</strong></p>
<p>官方的引导程序使用的是uboot，位于flash的Bootloader分区，而官方固件则位于OS1分区（红米AC2100）。正常刷openwrt的过程中不会修改bootloader。只要还保留着官方bootloader，就可以通过官方修复工具恢复。</p>
<p><strong>步骤：</strong></p>
<ol>
<li>下载<code>小米路由器修复工具</code>和官方镜像：<a href="https://www.xiaomi.cn/post/19184644" target="_blank" rel="noopener">【下载汇总】客户端/ROM下载 - 小米社区 (xiaomi.cn)</a></li>
<li><strong>路由器通电</strong>，PC通过网线连接到路由器LAN口</li>
<li>打开<code>MIWIFIRepairTool.x86.exe</code></li>
<li>选择镜像</li>
<li><strong>选择网卡</strong>（可以在网络中心中将其它网卡禁用）</li>
<li>断开路由器电源，按住rst键（也有可能需要用针戳），然后接上电源，等待黄灯闪烁（两个灯，一个是有电源标志，一个有互联网标志，这里为电源灯那个）</li>
<li>软件自动上传镜像</li>
<li>保持耐心等待路由器黄灯变蓝（中间过程保持黄灯），<strong>亲测需要4分钟</strong></li>
<li>断电后重新接上电源，路由器重启</li>
</ol>
<h3 id="刷了breed"><a href="#刷了breed" class="headerlink" title="刷了breed"></a>刷了breed</h3><p><strong>说明：</strong></p>
<p>breed自身便是一个bootloader，刷完breed后会覆盖原本的bootloader。如果想复原，可通过breed的功能，重新刷回官方bootloader。<strong>强烈建议刷breed前，先备份原本的bootloader以及整个flash</strong>。如果没备份，这里是恩山上收集的<strong>小米官方bootloader下载</strong>：<a href="https://www.right.com.cn/forum/thread-4102208-1-1.html" target="_blank" rel="noopener">论坛收集的几个小米路由器官方bootloader - 恩山无线论坛</a></p>
<p><strong>步骤：</strong></p>
<ol>
<li>通过breed刷回官方bootloader</li>
<li>通过官方修复工具修复</li>
</ol>
<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><h3 id="刷之前备份mtd分区"><a href="#刷之前备份mtd分区" class="headerlink" title="刷之前备份mtd分区"></a>刷之前备份mtd分区</h3><p>路由器flash有若干分区，其中有一个分区存储路由器MAC地址、无线校准参数等。若损坏可能导致无线信号弱等问题。因此刷之前最好备份。<br>查看mtd分区</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~<span class="comment"># cat /proc/mtd</span></span><br><span class="line">dev:    size   erasesize  name</span><br><span class="line">mtd0: 07f80000 00020000 <span class="string">"ALL"</span></span><br><span class="line">mtd1: 00080000 00020000 <span class="string">"Bootloader"</span></span><br><span class="line">mtd2: 00040000 00020000 <span class="string">"Config"</span></span><br><span class="line">mtd3: 00040000 00020000 <span class="string">"Bdata"</span></span><br><span class="line">mtd4: 00040000 00020000 <span class="string">"Factory"</span></span><br><span class="line">mtd5: 00040000 00020000 <span class="string">"crash"</span></span><br><span class="line">mtd6: 00040000 00020000 <span class="string">"crash_syslog"</span></span><br><span class="line">mtd7: 00040000 00020000 <span class="string">"reserved0"</span></span><br><span class="line">mtd8: 00400000 00020000 <span class="string">"kernel0"</span></span><br><span class="line">mtd9: 00400000 00020000 <span class="string">"kernel1"</span></span><br><span class="line">mtd10: 02000000 00020000 <span class="string">"rootfs0"</span></span><br><span class="line">mtd11: 02000000 00020000 <span class="string">"rootfs1"</span></span><br><span class="line">mtd12: 03580000 00020000 <span class="string">"overlay"</span></span><br><span class="line">mtd13: 012a6000 0001f000 <span class="string">"ubi_rootfs"</span></span><br><span class="line">mtd14: 030ec000 0001f000 <span class="string">"data"</span></span><br></pre></td></tr></table></figure>

<p>备份factory分区（小米路由器一般是factory存储了上述那些数据）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /dev/mtd4 &gt; /tmp/factory.bin</span><br></pre></td></tr></table></figure>

<p>之后通过scp复制到本地</p>
<h3 id="snapshot的说明"><a href="#snapshot的说明" class="headerlink" title="snapshot的说明"></a>snapshot的说明</h3><p>snapshot是开发版分支</p>
<ul>
<li>默认没有安装luci（没有网页界面）</li>
<li>上游每天都会编译产生新的snapshot。对于kernel mod相关软件，不是同一次编译则无法安装。</li>
<li><a href="https://openwrt.org/docs/guide-quick-start/developmentinstallation" target="_blank" rel="noopener">[OpenWrt Wiki] Installing OpenWrt development snapshots</a></li>
</ul>
<h3 id="命令行安装sysupgrade-bin"><a href="#命令行安装sysupgrade-bin" class="headerlink" title="命令行安装sysupgrade.bin"></a>命令行安装sysupgrade.bin</h3><ul>
<li><a href="https://openwrt.org/docs/guide-user/installation/sysupgrade.cli" target="_blank" rel="noopener">[OpenWrt Wiki] Upgrading OpenWrt firmware using CLI</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sysupgrade -v &#x2F;tmp&#x2F;firmware_image.bin</span><br><span class="line"></span><br><span class="line">#If sysupgrade is not available.</span><br><span class="line"># Flash firmware</span><br><span class="line">mtd -r write &#x2F;tmp&#x2F;firmware_image.bin firmware</span><br></pre></td></tr></table></figure>

<h3 id="备份恢复-CLI"><a href="#备份恢复-CLI" class="headerlink" title="备份恢复 CLI"></a>备份恢复 CLI</h3><ul>
<li>官方：<a href="https://openwrt.org/docs/guide-user/troubleshooting/backup_restore" target="_blank" rel="noopener">[OpenWrt Wiki] Backup and restore</a></li>
</ul>
<p>自己实现了一个自动配置openwrt脚本</p>
<ul>
<li><a href="https://github.com/TheRainstorm/my-openwrt-config" target="_blank" rel="noopener">TheRainstorm/my-openwrt-config (github.com)</a></li>
</ul>
<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><h4 id="iperf3"><a href="#iperf3" class="headerlink" title="iperf3"></a>iperf3</h4><p>ax6s &amp; mi4a</p>
<table>
<thead>
<tr>
<th>测试目的</th>
<th>连接</th>
<th>src</th>
<th>dst</th>
<th>speed(Mb/s)</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>ax6s LAN性能</td>
<td>千兆USB网卡</td>
<td>tianyi310</td>
<td>ax6s</td>
<td><strong>941</strong></td>
<td></td>
</tr>
<tr>
<td>ax6s 无线性能</td>
<td>wifi6 5Ghz@1201</td>
<td>s3pro</td>
<td>ax6s</td>
<td><strong>626</strong></td>
<td></td>
</tr>
<tr>
<td>mi4a LAN性能</td>
<td>2.5G网卡</td>
<td>ryzen</td>
<td>mi4a</td>
<td><strong><em>470</em></strong></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>隧道性能</td>
<td></td>
<td>tianyi310</td>
<td>ryzen</td>
<td>118</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>隧道性能</td>
<td></td>
<td>mi4a</td>
<td>ax6s</td>
<td>136</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>ax6s</td>
<td>mi4a</td>
<td>149</td>
<td></td>
</tr>
<tr>
<td>mi4a交换性能</td>
<td>ryzen - mi4a - p2w</td>
<td>ryzen</td>
<td>p2w</td>
<td><strong>943</strong></td>
<td>结果居然比ryzen - mi4a还要快！</td>
</tr>
</tbody></table>
<p>将r4a替换掉后<br>| 测试目的 | src       | dst       | speed(Mb/s) | 备注 |<br>| ——– | ——— | ——— | ———– | —- |<br>| p2w      | ryzen     | p2w       | <strong>936</strong>     |      |<br>|          | p2w       | ryzen     | <strong><em>577</em></strong>   |      |<br>| 隧道性能 | p2w       | ax6s      | 150         |      |<br>|          | ax6s      | p2w       | 250         |      |<br>| 隧道性能 | ryzen     | tianyi310 | <strong>295</strong>     |      |<br>|          | tianyi310 | ryzen     | <strong>173</strong>     |      |<br>|          | s3pro     | ryzen     | 256         |      |<br>| 780/886  | s3pro     | p2w       | <strong>370</strong>     |      |<br>|          | ryzen     | s3pro     | 274         |      |</p>
<h2 id="具体型号刷机过程"><a href="#具体型号刷机过程" class="headerlink" title="具体型号刷机过程"></a>具体型号刷机过程</h2><h3 id="Redmi-AC2100刷Openwrt"><a href="#Redmi-AC2100刷Openwrt" class="headerlink" title="Redmi AC2100刷Openwrt"></a>Redmi AC2100刷Openwrt</h3><h4 id="1-确认stock系统版本"><a href="#1-确认stock系统版本" class="headerlink" title="1. 确认stock系统版本"></a>1. 确认stock系统版本</h4><p>确认系统版本是否为2.0.23，如果不是，则在系统内手动升级到该版本<a href="http://cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/rm2100/miwifi_rm2100_all_fb720_2.0.23.bin" target="_blank" rel="noopener">http://cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/rm2100/miwifi_rm2100_all_fb720_2.0.23.bin</a></p>
<h4 id="2-获得ssh"><a href="#2-获得ssh" class="headerlink" title="2. 获得ssh"></a>2. 获得ssh</h4><p>使用web漏洞，获得ssh</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Work for RedMi 2100 firmware 2.0.23</span></span><br><span class="line"><span class="comment">// http://cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/rm2100/miwifi_rm2100_all_fb720_2.0.23.bin</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSTOK</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> match = location.href.match(<span class="regexp">/;stok=(.*?)\//</span>);</span><br><span class="line">    <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> match[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params">stok, command</span>) </span>&#123;</span><br><span class="line">    command = <span class="built_in">encodeURIComponent</span>(command);</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">`/cgi-bin/luci/;stok=<span class="subst">$&#123;stok&#125;</span>/api/misystem/set_config_iotdev?bssid=SteelyWing&amp;user_id=SteelyWing&amp;ssid=-h%0A<span class="subst">$&#123;command&#125;</span>%0A`</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(path);</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="keyword">new</span> Request(location.origin + path));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enableSSH</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    stok = getSTOK();</span><br><span class="line">    <span class="keyword">if</span> (!stok) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">'stok not found in URL'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`stok = "<span class="subst">$&#123;stok&#125;</span>"`</span>);</span><br><span class="line"></span><br><span class="line">    password = prompt(<span class="string">'Input new SSH password'</span>);</span><br><span class="line">    <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">'You must input password'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execute(stok, </span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">nvram set ssh_en=1</span></span><br><span class="line"><span class="string">nvram commit</span></span><br><span class="line"><span class="string">sed -i 's/channel=.*/channel=\\"debug\\"/g' /etc/init.d/dropbear</span></span><br><span class="line"><span class="string">/etc/init.d/dropbear start</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">    )</span><br><span class="line">        .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.text())</span><br><span class="line">        .then(<span class="function">(<span class="params">text</span>) =&gt;</span> <span class="built_in">console</span>.log(text));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'New SSH password: '</span> + password);</span><br><span class="line">    execute(stok, <span class="string">`echo -e "<span class="subst">$&#123;password&#125;</span>\\n<span class="subst">$&#123;password&#125;</span>" | passwd root`</span>)</span><br><span class="line">        .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.text())</span><br><span class="line">        .then(<span class="function">(<span class="params">text</span>) =&gt;</span> <span class="built_in">console</span>.log(text));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enableSSH();</span><br></pre></td></tr></table></figure>

<h4 id="3-下载openwrt镜像"><a href="#3-下载openwrt镜像" class="headerlink" title="3. 下载openwrt镜像"></a>3. 下载openwrt镜像</h4><p>从官方下载最新镜像，注意有四个文件</p>
<ul>
<li>kernel: 具有最少文件系统的Linux内核. 对于首次安装或恢复很有用.</li>
<li>kernel1: Linux内核作为单独的映像</li>
<li>rootfs0: 根文件系统作为单独的映像.</li>
<li>Sysupgrade: 使用Sysupgrade映像更新已经运行OpenWrt的路由器. 该映像可以与LuCI Web界面或终端一起使用.</li>
</ul>
<p>需要下载kernel1和rootfs0</p>
<ul>
<li><a href="https://downloads.openwrt.org/" target="_blank" rel="noopener">OpenWrt Downloads</a></li>
<li><a href="https://firmware-selector.openwrt.org/" target="_blank" rel="noopener">OpenWrt Firmware Selector</a></li>
</ul>
<h4 id="4-备份"><a href="#4-备份" class="headerlink" title="4. 备份"></a>4. 备份</h4><p>通过dmesg，知道一共有14个mtd分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[    2.940000] NAND device: Manufacturer ID: 0xc8, Chip ID: 0xd1 (ESMT NAND 128MiB 3,3V 8-bit), 128MiB, page size: 2048, OOB size: 64</span><br><span class="line">[    2.950000] [NAND]select ecc bit:4, sparesize :64 spare_per_sector&#x3D;16</span><br><span class="line">[    2.950000] Scanning device for bad blocks</span><br><span class="line">[    3.100000] Signature matched and data read!</span><br><span class="line">[    3.110000] load_fact_bbt success 1023</span><br><span class="line">...</span><br><span class="line">[    3.190000] Creating 14 MTD partitions on &quot;MT7621-NAND&quot;:</span><br><span class="line">[    3.190000] 0x000000000000-0x000007f80000 : &quot;ALL&quot;</span><br><span class="line">[    3.200000] 0x000000000000-0x000000080000 : &quot;Bootloader&quot;</span><br><span class="line">[    3.210000] 0x000000080000-0x0000000c0000 : &quot;Config&quot;</span><br><span class="line">[    3.210000] 0x0000000c0000-0x000000100000 : &quot;Bdata&quot;</span><br><span class="line">[    3.220000] 0x000000100000-0x000000140000 : &quot;Factory&quot;</span><br><span class="line">[    3.230000] 0x000000140000-0x000000180000 : &quot;crash&quot;</span><br><span class="line">[    3.230000] 0x000000180000-0x0000001c0000 : &quot;crash_syslog&quot;</span><br><span class="line">[    3.240000] 0x0000001c0000-0x000000200000 : &quot;cfg_bak&quot;</span><br><span class="line">[    3.240000] 0x000000200000-0x000000600000 : &quot;kernel0&quot;</span><br><span class="line">[    3.250000] 0x000000600000-0x000000a00000 : &quot;kernel1&quot;</span><br><span class="line">[    3.260000] 0x000000a00000-0x000002400000 : &quot;rootfs0&quot;</span><br><span class="line">[    3.260000] 0x000002400000-0x000003e00000 : &quot;rootfs1&quot;</span><br><span class="line">[    3.270000] 0x000003e00000-0x000006400000 : &quot;overlay&quot;</span><br><span class="line">[    3.280000] 0x000006400000-0x000007f80000 : &quot;obr&quot;</span><br><span class="line">[    3.280000] [mtk_nand] probe successfully!</span><br></pre></td></tr></table></figure>

<p>通过cat /proc/mtd，知道对应关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:&#x2F;tmp# cat &#x2F;proc&#x2F;mtd</span><br><span class="line">dev:    size   erasesize  name</span><br><span class="line">mtd0: 07f80000 00020000 &quot;ALL&quot;</span><br><span class="line">mtd1: 00080000 00020000 &quot;Bootloader&quot;</span><br><span class="line">mtd2: 00040000 00020000 &quot;Config&quot;</span><br><span class="line">mtd3: 00040000 00020000 &quot;Bdata&quot;</span><br><span class="line">mtd4: 00040000 00020000 &quot;Factory&quot;</span><br><span class="line">mtd5: 00040000 00020000 &quot;crash&quot;</span><br><span class="line">mtd6: 00040000 00020000 &quot;crash_syslog&quot;</span><br><span class="line">mtd7: 00040000 00020000 &quot;cfg_bak&quot;</span><br><span class="line">mtd8: 00400000 00020000 &quot;kernel0&quot;</span><br><span class="line">mtd9: 00400000 00020000 &quot;kernel1&quot;</span><br><span class="line">mtd10: 01a00000 00020000 &quot;rootfs0&quot;</span><br><span class="line">mtd11: 01a00000 00020000 &quot;rootfs1&quot;</span><br><span class="line">mtd12: 02600000 00020000 &quot;overlay&quot;</span><br><span class="line">mtd13: 01b80000 00020000 &quot;obr&quot;</span><br><span class="line">mtd14: 00c1c000 0001f000 &quot;ubi_rootfs&quot;</span><br><span class="line">mtd15: 021e8000 0001f000 &quot;data&quot;</span><br></pre></td></tr></table></figure>

<p>备份，其中Factory中存储了EEPROM的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;dev&#x2F;mtd4 &gt; Factory.dump</span><br><span class="line">cat &#x2F;dev&#x2F;mtd3 &gt; Bdata.dump</span><br><span class="line"></span><br><span class="line">scp复制到本地</span><br></pre></td></tr></table></figure>

<h4 id="5-设置环境变量"><a href="#5-设置环境变量" class="headerlink" title="5. 设置环境变量"></a>5. 设置环境变量</h4><p>设置环境变量（rm2100有双系统用于备份保护，需要设置先启动哪一个）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable uart and boot_wait, useful for testing or recovery if you have an uart adapter!</span></span><br><span class="line">nvram <span class="built_in">set</span> uart_en=1</span><br><span class="line">nvram <span class="built_in">set</span> boot_wait=on</span><br><span class="line">nvram <span class="built_in">set</span> bootdelay=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set kernel1 as the booting kernel</span></span><br><span class="line">nvram <span class="built_in">set</span> flag_try_sys1_failed=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Commit our nvram changes</span></span><br><span class="line">nvram commit</span><br></pre></td></tr></table></figure>

<h4 id="6-刷机"><a href="#6-刷机" class="headerlink" title="6. 刷机"></a>6. 刷机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mtd write kernel1.bin kernel1</span><br><span class="line">mtd -r write rootfs0.bin rootfs0</span><br></pre></td></tr></table></figure>

<h3 id="MI-4A千兆版"><a href="#MI-4A千兆版" class="headerlink" title="MI 4A千兆版"></a>MI 4A千兆版</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>可以漏洞获取shell，不必使用硬件编程器</p>
<p>2022/11/6日，因刷breed bootloader，使得MI 4A变砖。忠告：别用breed，会变得不幸。（你tm支持r3g，不支持mi 4a能不能写清楚）</p>
<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ol>
<li><p>首先需要使用<code>OpenWRTInvasion</code><strong>获取shell</strong>。参考：<a href="https://github.com/acecilia/OpenWRTInvasion" target="_blank" rel="noopener">acecilia/OpenWRTInvasion(github.com)</a>。</p>
<p>同时，该仓库也提供了获得shell后的刷机过程。</p>
<p>不过使用官方的<code>OpenWRTInvasion</code>会从github上下载文件，而因为网络原因可能会失败。恩山论坛中有用户提供了修改代码的离线版本，可以搜索使用。</p>
<p>不过也可以自行修改代码：修改<code>script.sh</code>，将其中的链接替换成本地链接。可以使用python -m http.server运行一个小的http服务，提供下载。例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -L <span class="string">"https://github.com/acecilia/OpenWRTInvasion/raw/master/script_tools/busybox-mipsel"</span> --insecure --output busybox</span><br><span class="line"></span><br><span class="line"><span class="comment">#改为,ip需要调整</span></span><br><span class="line">curl <span class="string">"http://192.168.31.189:8000/busybox-mipsel"</span> --output busybox</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考仓库README，成功获得shell后，如图所示。接着上传镜像（initramfs-kernel.bin和squashfs-sysupgrade.bin都可以，推荐使用后者），然后运行mtd write（用cat /proc/mtd查看有哪些分区）<br><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20221030210955796.png" alt="image-20221030210955796"></p>
</li>
<li><p>最后等待路由器重启完成即可。</p>
</li>
</ol>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p>breed使用说明：<a href="https://www.sohu.com/a/304140654_120096961" target="_blank" rel="noopener">https://www.sohu.com/a/304140654_120096961</a></p>
<p>breed刷openwrt教程<a href="https://www.ixigua.com/6974624328725824031" target="_blank" rel="noopener">https://www.ixigua.com/6974624328725824031</a></p>
<h3 id="MI-R3G"><a href="#MI-R3G" class="headerlink" title="MI R3G"></a>MI R3G</h3><p>官方教程：<a href="https://openwrt.org/toh/xiaomi/mir3g" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi Mi WiFi R3G (Mi Wifi Router 3G / MIR3G / MI3G / mi4a Gigabit)</a></p>
<p>r3g官方固件下载：<a href="https://firmware-selector.openwrt.org/?version=21.02.3&target=ramips%2Fmt7621&id=xiaomi_mi-router-3g">OpenWrt Firmware Selector</a></p>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><ul>
<li>FAT32格式U盘</li>
<li>一枚针用于戳路由器reset键</li>
<li>手机安装MIWIFI app</li>
</ul>
<h4 id="开启ssh"><a href="#开启ssh" class="headerlink" title="开启ssh"></a>开启ssh</h4><ol>
<li><p>更新为小米开发版固件：<a href="https://bigota.miwifi.com/xiaoqiang/rom/r3g/miwifi_r3g_firmware_12f97_2.25.124.bin" target="_blank" rel="noopener">https://bigota.miwifi.com/xiaoqiang/rom/r3g/miwifi_r3g_firmware_12f97_2.25.124.bin</a></p>
</li>
<li><p><strong>下载小米路由器手机客户端(应用商店MI WIFI)软件，绑定路由器</strong></p>
</li>
<li><p>根据<a href="https://d.miwifi.com/rom/ssh，开启SSH" target="_blank" rel="noopener">https://d.miwifi.com/rom/ssh，开启SSH</a></p>
<p><em>p.s. 1. 即使是同一型号，miwifi_ssh.bin也是不同的；2. ssh密码显示在该页面</em></p>
<ol>
<li>请将下载的工具包bin文件复制到U盘（FAT/FAT32格式）的根目录下，保证文件名为miwifi_ssh.bin；</li>
<li>断开小米路由器的电源，将U盘插入USB接口；</li>
<li>按住reset按钮之后重新接入电源，指示灯变为黄色闪烁状态即可松开reset键；</li>
<li>等待3-5秒后安装完成之后，小米路由器会自动重启，之后您就可以尽情折腾啦 ：）</li>
</ol>
</li>
</ol>
<h4 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h4><p>查看mtd分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~# cat &#x2F;proc&#x2F;mtd</span><br><span class="line">dev:    size   erasesize  name</span><br><span class="line">mtd0: 07f80000 00020000 &quot;ALL&quot;</span><br><span class="line">mtd1: 00080000 00020000 &quot;Bootloader&quot;</span><br><span class="line">mtd2: 00040000 00020000 &quot;Config&quot;</span><br><span class="line">mtd3: 00040000 00020000 &quot;Bdata&quot;</span><br><span class="line">mtd4: 00040000 00020000 &quot;Factory&quot;</span><br><span class="line">mtd5: 00040000 00020000 &quot;crash&quot;</span><br><span class="line">mtd6: 00040000 00020000 &quot;crash_syslog&quot;</span><br><span class="line">mtd7: 00040000 00020000 &quot;reserved0&quot;</span><br><span class="line">mtd8: 00400000 00020000 &quot;kernel0&quot;</span><br><span class="line">mtd9: 00400000 00020000 &quot;kernel1&quot;</span><br><span class="line">mtd10: 02000000 00020000 &quot;rootfs0&quot;</span><br><span class="line">mtd11: 02000000 00020000 &quot;rootfs1&quot;</span><br><span class="line">mtd12: 03580000 00020000 &quot;overlay&quot;</span><br><span class="line">mtd13: 012a6000 0001f000 &quot;ubi_rootfs&quot;</span><br><span class="line">mtd14: 030ec000 0001f000 &quot;data&quot;</span><br></pre></td></tr></table></figure>

<p>备份factory分区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;dev&#x2F;mtd4 &gt; &#x2F;tmp&#x2F;factory.bin</span><br><span class="line"></span><br><span class="line">#on windows</span><br><span class="line">scp root@192.168.33.193:&#x2F;tmp&#x2F;factory.bin .</span><br><span class="line">scp root@192.168.33.228:&#x2F;tmp&#x2F;factory.bin .</span><br></pre></td></tr></table></figure>

<h4 id="刷openwrt"><a href="#刷openwrt" class="headerlink" title="刷openwrt"></a>刷openwrt</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mtd write openwrt-18.06.2-ramips-mt7621-mir3g-squashfs-kernel1.bin kernel1</span><br><span class="line">mtd write openwrt-18.06.2-ramips-mt7621-mir3g-squashfs-rootfs0.bin rootfs0</span><br><span class="line">nvram set flag_try_sys1_failed&#x3D;1</span><br><span class="line">nvram commit</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="AX6S"><a href="#AX6S" class="headerlink" title="AX6S"></a>AX6S</h3><p>AX6S为国内版，国外版称为AX3200</p>
<ul>
<li>SoC：<strong>MT7622</strong>B: 2 x <a href="mailto:A53@1.35GHz">A53@1.35GHz</a> CPU。<ul>
<li>满血版本是MT7622A，少了蓝牙就是MT7622BV，没有蓝牙和多媒体功能的是MT7622B，基本剩下无线功能的是MT7622E</li>
</ul>
</li>
<li>ram: 256 + flash: 128</li>
<li><a href="https://openwrt.org/toh/xiaomi/ax3200" target="_blank" rel="noopener">[OpenWrt Wiki] Xiaomi AX3200 / Redmi AX6S</a></li>
</ul>
<h4 id="openwrt-git分支"><a href="#openwrt-git分支" class="headerlink" title="openwrt git分支"></a>openwrt git分支</h4><p>图中蓝色为master分支，绿色为21.02稳定版分支，橙色为LEDE19.07分支，而粉色的为新的22.03测试版分支。可以看到AX6S最早在master分支中得到支持，然后不久便在22.03中得到了添加。</p>
<ul>
<li>好奇为何不使用merge</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20220802134158765.png" alt="image-20220802134158765"></p>
<p>21.02稳定版分支，当初也是从master分支中分离出来的</p>
<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20220802134945115.png" alt="image-20220802134945115"></p>
<h5 id="immortal-wrt"><a href="#immortal-wrt" class="headerlink" title="immortal wrt"></a>immortal wrt</h5><ul>
<li><a href="https://github.com/immortalwrt/immortalwrt" target="_blank" rel="noopener">immortalwrt/immortalwrt: An opensource OpenWrt variant for mainland China users. (github.com)</a></li>
</ul>
<p>有以下这些分支。开发流程为将官方分支合并到自己的分支。但是21.02稳定版仍然没有AX6S的支持，网上看到的是18.06-k5.4分支的</p>
<ul>
<li><a href="https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8187405" target="_blank" rel="noopener">AX6S 闭源无线驱动Openwrt 刷机教程/固件下载-小米无线路由器以及小米无线相关的设备-恩山无线论坛 (right.com.cn)</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* openwrt-21.02</span><br><span class="line">  remotes&#x2F;origin&#x2F;HEAD -&gt; origin&#x2F;openwrt-21.02</span><br><span class="line">  remotes&#x2F;origin&#x2F;master</span><br><span class="line">  remotes&#x2F;origin&#x2F;openwrt-18.06</span><br><span class="line">  remotes&#x2F;origin&#x2F;openwrt-18.06-k5.4</span><br><span class="line">  remotes&#x2F;origin&#x2F;openwrt-21.02</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/image-20220802142756560.png" alt="image-20220802142756560"></p>
<h3 id="竞斗云2-0"><a href="#竞斗云2-0" class="headerlink" title="竞斗云2.0"></a>竞斗云2.0</h3><p>需要先刷入opboot（一个第三方bootloader）<a href="https://www.red-yellow.net/竞斗云2刷opboot.html" target="_blank" rel="noopener">竞斗云2刷opboot - 路由智态 (red-yellow.net)</a></p>
<p>然后再刷openwrt。<br>编译：<a href="https://www.red-yellow.net/%e7%ab%9e%e6%96%97%e4%ba%912%e7%9a%84openwrt%e5%9b%ba%e4%bb%b6.html" target="_blank" rel="noopener">竞斗云2的OpenWrt固件 - 路由智态 (red-yellow.net)</a></p>
<p>比较担心opboot和opewrt最新版的兼容性。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/13/openwrt%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/images_lx/avatar_idenn.png">
      <meta itemprop="name" content="rain">
      <meta itemprop="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="rain的随笔">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/13/openwrt%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">openwrt编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-13 01:18:16" itemprop="dateCreated datePublished" datetime="2022-02-13T01:18:16+08:00">2022-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-03 21:15:09" itemprop="dateModified" datetime="2022-11-03T21:15:09+08:00">2022-11-03</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/02/13/openwrt%E7%BC%96%E8%AF%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/02/13/openwrt%E7%BC%96%E8%AF%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Openwrt-编译"><a href="#Openwrt-编译" class="headerlink" title="Openwrt 编译"></a>Openwrt 编译</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><h4 id="自己编译优点"><a href="#自己编译优点" class="headerlink" title="自己编译优点"></a>自己编译优点</h4><ol>
<li><p>固件体积减小（需要安装的package被压缩到镜像中）</p>
</li>
<li><p>可以定制一些需要的选项（busybox可以选择zsh）</p>
</li>
<li><p>下次刷机，可以不用进行软件安装，配置</p>
</li>
</ol>
<blockquote>
<p>The main advantage of building your own firmware is that it compresses the files, so that you will have room for much more stuff. It is particularly noticeable on routers <strong>with 16 MB flash RAM or less</strong>. It also lets you change some options that can only be changed at build time, for instance the features included in BusyBox and the block size of SquashFS. Larger block size will give better compression, but may also slow down the loading of files. (ref: <a href="https://openwrt.org/docs/guide-user/additional-software/beginners-build-guide" target="_blank" rel="noopener">[OpenWrt Wiki] Quick image building guide</a>)</p>
</blockquote>
<h4 id="Openwrt-Build-System特点"><a href="#Openwrt-Build-System特点" class="headerlink" title="Openwrt Build System特点"></a>Openwrt Build System特点</h4><ul>
<li>不用配置编译链</li>
</ul>
<blockquote>
<p>While it is possible to manually create your toolchain, and then build OpenWrt with it, this is difficult and error-prone. The OpenWrt build system takes a different approach to building a firmware: it downloads, patches and compiles everything from scratch, including the cross compiler. Or to put it in simpler terms, OpenWrt’s build system doesn’t contain any executables or even sources. It is an automated system for downloading the sources, patching them to work with the given platform and compiling them correctly for the platform. What this means is that just by changing the template, you can change any step in the process. And of course the side benefit of this is that builds are automated, which saves time and guarantees the same result every time.</p>
<p>For example if a new kernel is released, a simple change to one of the Makefiles will download the latest kernel, patch it to run on the requested platform and produce a new firmware image. There’s no work to be done trying to track down an unmodified copy of the existing kernel to see what changes had been made - the patches are already provided and the process ends up almost completely transparent. This doesn’t just apply to the kernel, but to anything included with OpenWrt - it’s this strategy that allows OpenWrt to stay on the bleeding edge with the latest compilers, kernels and applications. (ref: <a href="https://openwrt.org/docs/guide-developer/build-system/buildsystem_essentials" target="_blank" rel="noopener">[OpenWrt Wiki] Build system essentials</a>)</p>
</blockquote>
<ul>
<li>编译出来的toolchain位置</li>
</ul>
<blockquote>
<p><code>staging_dir/toolchain…</code> is a mini Linux root with its own <code>bin/</code>, <code>lib/</code>, etc that contains the cross C compiler used to build the rest of the firmware. You can actually use that to compile simple C programs outside of OpenWRT that can be loaded onto the firmware. The C compiler might be something like: <code>staging_dir/toolchain-mips_34kc_gcc-4.8-linaro_uClibc-0.9.33.2/bin/mips-openwrt-linux-uclibc-gcc</code>. You can see the version of the CPU, the C library and gcc encoded into it; this allows multiple targets to be built in the same area concurrently.</p>
</blockquote>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p>根据<a href="https://openwrt.org/docs/guide-developer/toolchain/install-buildsystem" target="_blank" rel="noopener">[OpenWrt Wiki] Build system setup</a>安装对应</p>
<h4 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h4><ul>
<li><p>参考：</p>
<ul>
<li>官方教程：<a href="https://openwrt.org/docs/guide-developer/toolchain/use-buildsystem" target="_blank" rel="noopener">[OpenWrt Wiki] Build system usage</a></li>
<li>非常好的一个教程：<a href="https://gist.github.com/chankruze/dee8c2ba31c338a60026e14e3383f981" target="_blank" rel="noopener">How To Compile OpenWrt Firmware For Any Router · GitHub</a></li>
</ul>
</li>
<li><p>命令汇总</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download and update the sources</span></span><br><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git</span><br><span class="line"><span class="built_in">cd</span> openwrt</span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># Select a specific code revision</span></span><br><span class="line">git branch -a</span><br><span class="line">git tag</span><br><span class="line">git checkout v21.02.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update the feeds</span></span><br><span class="line">./scripts/feeds update -a</span><br><span class="line">./scripts/feeds install -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the firmware image and the kernel</span></span><br><span class="line">make menuconfig</span><br><span class="line"><span class="comment">#make kernel_menuconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#download all dependency source files before final make, enables multi-core compilation</span></span><br><span class="line">make download</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build the firmware image</span></span><br><span class="line"><span class="comment">#make (or make world)</span></span><br><span class="line"><span class="comment">#when faild, V=s show all command executed</span></span><br><span class="line"><span class="comment">#make V=s</span></span><br><span class="line"></span><br><span class="line">make -j $(nproc) 2&gt;&amp;1 | teemake.log</span><br></pre></td></tr></table></figure>
</li>
<li><p>Cleaning Up</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">make clean <span class="comment">#deletes contents of the directories /bin and /build_dir. make clean does not remove the toolchain, it also avoids cleaning architectures/targets other than the one you have selected in your .config</span></span><br><span class="line"></span><br><span class="line">make dirclean <span class="comment">#deletes contents of the directories /bin and /build_dir and additionally /staging_dir and /toolchain (=the cross-compile tools) and /logs. 'Dirclean' is your basic "Full clean" operation.</span></span><br><span class="line"></span><br><span class="line">make distclean <span class="comment">#nukes everything you have compiled or configured and also deletes all downloaded feeds contents and package sources.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#clean small part</span></span><br><span class="line">make target/linux/clean  		<span class="comment">#Clean linux objects </span></span><br><span class="line">make package/base-files/clean 	<span class="comment">#Clean package base-files objects</span></span><br><span class="line">make package/luci/clean 		<span class="comment">#Clean luci</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="编译配置-menuconfig"><a href="#编译配置-menuconfig" class="headerlink" title="编译配置(menuconfig)"></a>编译配置(menuconfig)</h3><ul>
<li>Target System(MediaTek Ralink MIPS)</li>
<li>Subtarget(MT7621 based boards)</li>
<li>Target Profile(Xiaomi Redmi Router AC2100)</li>
<li><strong>Target Images</strong><ul>
<li>取消勾选ramdisk，否者会生成<code>openwrt-ramips-mt7621-xiaomi_mi-router-4a-gigabit-initramfs-kernel.bin</code></li>
<li>勾选squashfs，可以调节block size（默认256B），越大的块压缩率更好，但读取速度更慢（可能影响重启速度？）</li>
</ul>
</li>
<li>Build the Openwrt SDK：一个小的buildroot，用于测试自己的package</li>
<li>Package the Openwrt-based Toolchain：交叉编译链</li>
<li>Base system<ul>
<li>使用Openclash需要取消勾选dnsmasq（已经勾选dnsmasq-full）</li>
<li><strong>中文乱码</strong>：make menuconfig-&gt;Base System-&gt;busybox-&gt;Customize busybox option-&gt;Settings-&gt;support unicode选项（位于结尾）勾上后，勾上选项Check $LANG environment variable</li>
</ul>
</li>
<li>Administration<ul>
<li>htop</li>
</ul>
</li>
<li>Development<ul>
<li>gcc, gdb等工具</li>
</ul>
</li>
<li>Fonts<ul>
<li>DejaVu字体</li>
</ul>
</li>
<li><strong>Kernel modules</strong><ul>
<li>Other modules: kmod-mtd-rw：开启uboot等flash分区写权限</li>
<li>USB support: <code>kmod-usb-core kmod-usb-storage kmod-usb-uhci kmod-usb2 kmod-usb3</code></li>
<li>Video support: kmod-video-core kmod-video-uvc</li>
</ul>
</li>
<li>Languages<ul>
<li>python：requests, lxml</li>
</ul>
</li>
<li><strong>Luci</strong><ul>
<li>Collections<ul>
<li><strong>Luci</strong>：否则没有图形界面</li>
</ul>
</li>
<li>Module<ul>
<li>luci-compat：据说是必要的</li>
</ul>
</li>
<li>Application<ul>
<li>adblock</li>
<li><strong>ddns</strong></li>
<li>Openclash（需要自己添加）</li>
<li>qos</li>
<li>samba4: usb（需要usb挂载东西的话）</li>
<li>upnp</li>
<li><strong>wireguard</strong></li>
<li>wol</li>
</ul>
</li>
</ul>
</li>
<li>Network<ul>
<li>Files Transfer: curl</li>
<li>VPN: <strong>zerotier</strong></li>
<li><strong>immortalwrt需要开启</strong>: odhcp6c, odhcpd-ipv6only，否则ipv6无法使用</li>
<li>WirelessPAD:<ul>
<li>wpad-openssl：最完整</li>
<li>wpad-mesh-openssl</li>
<li>wpad-basic-openssl</li>
</ul>
</li>
</ul>
</li>
<li>Utilities<ul>
<li>Editors：vim-full（只能选一个）</li>
<li>Shells：bash</li>
</ul>
</li>
</ul>
<h4 id="image大小参考"><a href="#image大小参考" class="headerlink" title="image大小参考"></a>image大小参考</h4><p>满足16MB的一种配置：</p>
<ul>
<li>squashfs块大小设置为512KB</li>
<li>开启：htop, <strong>python</strong>(requests, lxml), <strong>Luci</strong>, adblock, ddns, qos, upnp, <strong>wireguard</strong>, wol, <strong>zerotier</strong>, vim-full, bash</li>
<li>大小为15991868B/16121856B，把k2p压榨到只剩126KB了。</li>
</ul>
<h4 id="usb"><a href="#usb" class="headerlink" title="usb"></a>usb</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#kmod &gt; usb support</span><br><span class="line">kmod-usb-core kmod-usb-storage kmod-usb-uhci kmod-usb2 kmod-usb3</span><br></pre></td></tr></table></figure>

<h4 id="webcam"><a href="#webcam" class="headerlink" title="webcam"></a>webcam</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#kmod &gt; video support</span><br><span class="line">kmod-video-core kmod-video-uvc</span><br><span class="line"></span><br><span class="line">#Multimedia</span><br><span class="line">mjpg-streamer</span><br><span class="line">input-uvc</span><br><span class="line">output-rtsp</span><br><span class="line">www-simple</span><br><span class="line"></span><br><span class="line">#luci</span><br><span class="line">luci-app-mjpg-streamer</span><br><span class="line"></span><br><span class="line">#utils(optional)</span><br><span class="line">uvcdynctrl</span><br></pre></td></tr></table></figure>

<h4 id="opkg安装其它软件"><a href="#opkg安装其它软件" class="headerlink" title="opkg安装其它软件"></a>opkg安装其它软件</h4><p>剩余一些可选的使用opkg安装更方便</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mtr-json tmux iperf3 tcpdump htop vim-full</span><br></pre></td></tr></table></figure>



<h3 id="闭源驱动"><a href="#闭源驱动" class="headerlink" title="闭源驱动"></a>闭源驱动</h3><p>看到很多非openwrt官方固件都提到了闭源驱动因此了解了一波</p>
<p>大概就是MTK有mt76无线的驱动代码，但是openwrt内使用的是自己开发的驱动。</p>
<p><a href="https://forum.openwrt.org/t/mt76-driver-replacement-for-test/58469/18" target="_blank" rel="noopener">Mt76 driver - replacement [for test] - For Developers - OpenWrt Forum</a></p>
<p><a href="https://git01.mediatek.com/plugins/gitiles/openwrt/feeds/mtk-openwrt-feeds/" target="_blank" rel="noopener">openwrt/feeds/mtk-openwrt-feeds - Gitiles (mediatek.com)</a></p>
<h3 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h3><h4 id="无5Ghz无线"><a href="#无5Ghz无线" class="headerlink" title="无5Ghz无线"></a>无5Ghz无线</h4><p>刚开始编译了rm2100，make clean后，编译了r3g。结果发现一切都好，就是没有5Ghz无线。而使用官方版本是有的。</p>
<p>尝试make dirclean后(full clean)，重新编译，问题解决。</p>
<h4 id="测速速度慢"><a href="#测速速度慢" class="headerlink" title="测速速度慢"></a>测速速度慢</h4><p>测速上传下载都是300左右</p>
<p>尝试保存配置后，在系统中reset，然后重新加载配置。</p>
<ul>
<li>reset后，速度很快，基本上上传可以到600-700，下载900-1000</li>
<li>重新加载配置后，速度依旧很快</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="rain"
      src="/images/images_lx/avatar_idenn.png">
  <p class="site-author-name" itemprop="name">rain</p>
  <div class="site-description" itemprop="description">记录一些关于数学、计算机的知识，以及一些日常。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/TheRainstorm" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;TheRainstorm" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1544016010@qq.com" title="E-Mail → mailto:1544016010@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rain</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'o4cQoSCyl8A6rNyF3TQecBOG-gzGzoHsz',
      appKey     : 'RN9rQAQldGQFicEMmzpFUcMA',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
